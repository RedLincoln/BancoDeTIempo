<!-- Generated by Vue on Rails https://github.com/vueonrails/vueonrails -->
<!-- The corresponding pack is app/javascript/packs/transaction_form.js -->
<!-- Generate another component part like this by running command `rails generate vue something` -->

<template>
  <div class="transaction-form dropdown">
    <ul v-if="haveErrors" class="errors">
      <li
        v-for="(error, name, index) in errors"
        :key="index"
        :class="`error_${name}`"
      >
        {{ error }}
      </li>
    </ul>
    <form
      class="service-petition border-top mt-2"
      :action="$createTransactionPath"
      method="post"
      @submit.prevent="sendPetition"
    >
      <input name="utf8" type="hidden" value="✓" />
      <input type="hidden" name="authenticity_token" :value="$getCSRFToken()" />
      <input type="hidden" name="transaction[service_id]" :value="service_id" />
      <div class="field">
        <DatetimePicker></DatetimePicker>
      </div>
      <div class="field form-group">
        <label for="transaction-duration">Duración: </label>
        <input
          placeholder="Número de horas"
          :value="duration"
          @input="validateInteger"
          name="transaction[duration]"
          id="transaction-duration"
          class="form-control"
        />
      </div>
      <div class="field form-group">
        <label for="addition_information">Información aditional:</label>
        <br />
        <textarea
          class="form-control"
          name="transaction[addition_information]"
          id="addition_information"
          placeholder="Añade información extra"
          rows="3"
          cols="40"
        ></textarea>
      </div>
      <div class="actions">
        <button class="send_petition btn btn-primary">Enviar</button>
      </div>
    </form>
  </div>
</template>

<script>
import axios from "axios";
import railsFlash from "../railsFlash";
import formParams from "../formHelper";
import DatetimePicker from "./DatetimePicker/DatetimePicker";
import _ from "lodash/lang";

export default {
  props: {
    service_id: {
      type: Number,
      required: true,
    },
  },
  components: {
    DatetimePicker,
  },
  data: function() {
    return {
      errors: {},
      duration: 0,
    };
  },
  computed: {
    haveErrors() {
      return !_.isEmpty(this.errors);
    },
  },
  methods: {
    validateInteger(event) {
      console.log(event.target.value);
      this.duration = 0;
      this.$forceUpdate();
    },
    sendPetition: function(e) {
      axios
        .post(
          this.$createTransactionPath,
          formParams.getPostParams(e.target.elements)
        )
        .then((response) => {
          this.errors = {};
        })
        .catch((err) => {
          railsFlash.alert(err.data.message);
          this.errors = err.data.errors;
        });
    },
  },
};
</script>

<style scoped>
textarea {
  resize: none;
}

input,
textarea {
  font-size: 1rem;
}
</style>
